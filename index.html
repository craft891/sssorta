<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Factor Hive Client</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #log { white-space: pre; background:#f0f0f0; padding:10px; height:200px; overflow:auto; }
    input { margin: 5px; }
  </style>
</head>
<body>
  <h1>Factor Hive Client</h1>
  <label>Server URL: <input id="serverUrl" value="ws://localhost:3000"></label>
  <button id="connectBtn">Connect</button>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
  <div id="log"></div>

<script>
let ws;
let state = {
  originalN: null,
  N_work: null,
  totalIterations: 0n,
  found: null
};
let workers = {};
let workerCount = 0;

function log(msg){
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}
function toBigIntSafe(x){ try { return BigInt(x); } catch { return null; } }

// --- Worker script (inline) ---
const workerScript = `
self.onmessage = function(e){
  const {cmd, N, id, c, chunk, taskId} = e.data;
  if(cmd==="start"){
    const Nn = BigInt(N);
    let x=2n, y=2n, d=1n;
    let count = 0n;
    function f(x){ return (x*x + BigInt(c)) % Nn; }
    while(true){
      x=f(x); y=f(f(y));
      d = gcd(abs(x-y), Nn);
      count++;
      if(d>1n && d<Nn){
        self.postMessage({type:"found", factor:d.toString(), id, taskId});
        break;
      }
      if(count % BigInt(chunk)===0n){
        self.postMessage({type:"progress", id, taskId, offset:count.toString()});
      }
    }
  }
};
function abs(a){ return a<0n?-a:a; }
function gcd(a,b){ while(b){ [a,b] = [b, a%b]; } return a; }
`;
const workerURL = URL.createObjectURL(new Blob([workerScript], {type:'application/javascript'}));

// --- Server comms ---
function connect(){
  const url = document.getElementById("serverUrl").value;
  ws = new WebSocket(url);
  ws.onopen = () => {
    log("Connected to server.");
    ws.send(JSON.stringify({type:"register", capacity:1}));
  };
  ws.onmessage = ev => {
    const m = JSON.parse(ev.data);
    handleServerMessage(m);
  };
  ws.onclose = () => log("Disconnected.");
}
function handleServerMessage(m){
  if(m.type==="ack"){ log("Registered as "+m.clientId); }
  else if(m.type==="state"){
    if(m.state){
      if(m.state.N_original) state.originalN = toBigIntSafe(m.state.N_original);
      if(m.state.N_work) state.N_work = toBigIntSafe(m.state.N_work);
      if(m.state.totalIterations) state.totalIterations = toBigIntSafe(m.state.totalIterations);
      if(m.state.found) state.found = m.state.found;
      log("Server state received.");
    }
  }
  else if(m.type==="assign"){
    for(const t of m.tasks){
      if(!state.originalN && t.N){
        state.originalN = toBigIntSafe(t.N);
        state.N_work = toBigIntSafe(t.N);
        log("Set originalN from task: "+t.N);
      }
      startWorker(t);
    }
  }
}
function sendProgress(taskId, offset){
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({type:"progress", taskId, offset}));
  }
}
function sendFound(factor, taskId){
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({type:"found", factor, taskId}));
  }
}

// --- Worker mgmt ---
function startWorker(task){
  const id = "w"+(++workerCount);
  const w = new Worker(workerURL);
  workers[id] = {w, taskId: task.taskId};
  w.onmessage = e => {
    const m = e.data;
    if(m.type==="progress"){
      sendProgress(m.taskId, m.offset);
    } else if(m.type==="found"){
      const p = BigInt(m.factor);
      if(state.originalN && p>1n && p<state.originalN && state.originalN%p===0n){
        log("Factor found! p="+p+" q="+(state.originalN/p));
        sendFound(p.toString(), m.taskId);
      } else {
        log("Worker reported invalid factor "+m.factor);
      }
      w.terminate();
    }
  };
  w.postMessage({cmd:"start", N: task.N || state.N_work?.toString() || state.originalN?.toString(), id, c: task.c, chunk: 1000, taskId: task.taskId});
  log("Started worker "+id+" for task "+task.taskId);
}

// --- UI buttons ---
document.getElementById("connectBtn").onclick = connect;
document.getElementById("startBtn").onclick = () => {
  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({type:"requestTasks", capacity:1}));
  } else log("Not connected.");
};
document.getElementById("stopBtn").onclick = () => {
  for(const id in workers){ workers[id].w.terminate(); }
  workers={};
  log("All workers stopped.");
};
</script>
</body>
</html>
